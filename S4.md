# Step 4: Making our Hypermedia-Driven Application
We now have a working form with a confirmation step.
However, the experience isn't very modern.
The entire page reloads when we click Confirm or Submit.
We have to go back in our browser if we want to modify our form data after previewing it.

Let's modernize it and turn our contact form into a
[Hypermedia-Driven Application](https://htmx.org/essays/hypermedia-driven-applications/).

## Why HTMX is great

Take a look at the `contact_page.html`

```html
{% extends 'base.html' %}

{% block content %}
    <form action="/confirm/" method="post">
        {% csrf_token %}
        {{ form.as_div }}
        <button>
            <input type="submit" value="Confirm">
        </button>
    </form>
{% endblock %}
```
Right now, the 'action' and 'method' are set to the `<form>` tag.
That's normal because in traditional HTML, only forms and links can send HTTP requests.

HTMX upgrades and completes HTML as a hypertext. With HTMX, 

1. _Any_ HTML element to make an HTTP request.
2. _All_ events to trigger HTTP requests, not just clicks and submits.
3. _All_ HTTP request methods are available in HTML.
4. You are free to replace arbitrary elements in the HTML (you don't have to replace the whole screen).

It's a huge upgrade, but doesn't come at the cost of complexity and fragility inherent in other Javascript frameworks like React.
It also allows us to build our sites in our choice of web framework backends (like Django or Ruby on Rails).
We aren't forced to code our front and back ends in Javascript.

I've said enough, grug brother. Let's get coding.

## Add and modify templates
For this tutorial, we are going to use the template organization and usage recommended by Adam Chainz
in his [example project](https://github.com/adamchainz/django-htmx/tree/main/example) for Django HTMX.


### Add `contact_form_partial.html`
```html
<!-- contact_form_partial.html -->
<div id="contact-form">
    {% block contact_form %}{% endblock %}
</div>
```

### Add `contact_form.html`

```html
<!-- contact_form.html -->
<!-- base_template will be defined as contact_form_partial.html in our view. -->
{% extends base_template %}

<!-- This block is defined in base_template. -->
{% block contact_form %}
<!-- No method or action attributes. -->
    <form>
        {% csrf_token %}
        {{ form.as_div }}
        <button hx-post="confirm/"
                hx-target="#contact-form"
                hx-swap="outerHTML"
                type="submit">
            Confirm
        </button>
    </form>
{% endblock %}
```

### Modify `contact_page.html`
```html
% extends 'base.html' %}

{% block content %}
    <!-- We moved the form to 'contact_form.html', so include it here. -->
    {% include 'contact_form.html' %}
{% endblock %}
```

### Modify `confirmation_page.html`
```html
{% extends base_template %}

<!-- contact_form, not content -->
{% block contact_form %}
    <form>
        {% csrf_token %}
        {% for field in form %}
            <div>
            <!-- Important! -->
            <!-- The field needs to be in the form even in the confirmation view -->
            <!-- We don't need to see it, though, so lets make it hidden with as_hidden -->
            {{ field.as_hidden }}
            {{ field.label }}:
            {{ field.value }}
            </div>
        {% endfor %}
        <button hx-post="send/"
                hx-target="#contact-form"
                hx-swap="outerHTML"
                type="submit">
            Send
        </button>
    </form>
{% endblock %}
```

### Modify `success_page.html`
```html
{% extends base_template %}

{% block contact_form %}
    <h1>Complete</h1>
{% endblock %}
```

Here are long last is our HTMX. Let's zoom in.

```html
<form>
    {% csrf_token %}
    {{ form.as_div }}
    <button hx-post="confirm/"
            hx-target="#contact-form"
            hx-swap="outerHTML"
            type="submit">
        Confirm
    </button>
</form>
```

Like I wrote above, HTMX lets us send HTTP requests, like POST, using _any_ element,
not just forms. In this case, we could put the HTMX attributes in the `<form>` tag
and the results would stay the same.

`hx-post="confirm/"` is like a combination of `method="post"` and `action="confirm/"`.
The response to the request will replace the `hx-target` using the swap method in
`hx-swap`.

## Modify `base.html`

```html
<!-- Add hx-headers -->
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
      class="bg-gray-50 font-serif leading-normal tracking-normal">
```

## Modify views

```python
from django.shortcuts import render, redirect
from .forms import ContactForm
from django.views.generic import FormView, TemplateView

class ContactPageView(FormView):
    template_name = 'contact_page.html'
    # contact_page.html {% includes %} 'contact_form.html'
    # contact_form.html extends base_template.
    base_template = 'contact_form_partial.html'
    # We add base_template to the context so that we can reference it in the template.
    extra_context = {'base_template': base_template}
    form_class = ContactForm
    success_url = '/confirm/'

  
class ConfirmationView(FormView):
    template_name = 'confirmation_page.html'
    base_template = 'contact_form_partial.html'
    extra_context = {'base_template': base_template}
    form_class = ContactForm
    submit = False
    success_url = '/success/'

    # By default, if a FormView detects a POST request, it will run validation on it
    # and send it to form_valid, which will simply redirect to success_url.
    # That means we would never even see the confirmation view in the browser.
    # We need to override the post method of FormView to see the confirmation 'page'.
    def post(self, request, *args, **kwargs):
        # See urls.py
        if self.submit is True:
            return self.validate_form()
        return render(self.request, self.template_name, self.get_context_data())
    
    # Helper method.
    # Create a ContactForm instance with POST request data and validate it.
    def validate_form(self):
        form_class = self.get_form_class()
        form = self.get_form(form_class)
        if form.is_valid():
            return self.form_valid(form)
    
    def form_valid(self, form):
        form.send()
        return redirect(self.success_url)


class SuccessView(TemplateView):
    template_name = 'success_page.html'
    base_template = 'contact_form_partial.html'
    extra_context = {'base_template': base_template}
```

See comments for details. We override the `post` method in `ConfirmationView` to first
show the confirmation template, then actually submit and send the email when the 
user clicks the submit button on this view.

## Modify `urls.py`

```python
urlpatterns = [
    path('', views.ContactPageView.as_view(), name='contact_page'),
    # Change this line
    path('confirm/', views.ConfirmationView.as_view()),
    # Add this line
    path('send/', views.ConfirmationView.as_view(submit=True)),
    path('success/', views.SuccessView.as_view())
]
```

Save and test it out. If you look in the console, 
you'll see that POST requests are sent to confirm/, send/, etc,
but you stay on the same page (the URL in the browser doesn't change).

Neat.

But, of course, we're confirming because the user might want to edit the information.
In the confirmation view, if we press the back button,
we leave the contact page entirely. That's no good. Let's use HTMX to fix that.

## Add `Edit` button to confirmation_page.html

```html
<button hx-post="send/"
        hx-target="#contact-form"
        hx-swap="outerHTML"
        type="submit">
    Send
</button>
<button hx-post="/"
        hx-target="#contact-form"
        hx-swap="outerHTML"
        type="submit">
    Edit
</button>
```

Remember: HTMX upgrades HTML and lets us make HTTP requests with any element.
Now our form isn't bound to one method and action.

One button will send the email with the data in the form `field`,
one button will send us back to the index (in this case, `contact_page.html`)
carrying our post data. Now all we need to do is update `ContactPageView`.

## Update `ContactPageView`

```python
class ContactPageView(FormView):
    ...
    def post(self, request, *args, **kwargs):
        return render(self.request, self.template_name, self.get_context_data())
    ...
```

Just like with `ConfirmationView`, we override the default behavior on the `post` method.

Now we have upgraded our contact form with HTMX.

The functionality is complete. Now we need to fix the design and
make the form look good with another member of the GRUG stack: TailwindCSS.