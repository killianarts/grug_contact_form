# Step 4: Enhance with HTMX
We now have a working form with a confirmation step.
However, the experience isn't very modern.
The entire page reloads when we click Confirm or Submit.
We have to go back in our browser if we want to modify our form data after previewing it.

Let's fix that with HTMX.

## Why HTMX is great

Take a look at the `contact_page.html`

```html
{% extends 'base.html' %}

{% block content %}
    <form action="/confirm/" method="post">
        {% csrf_token %}
        {{ form.as_div }}
        <button>
            <input type="submit" value="Confirm">
        </button>
    </form>
{% endblock %}
```
Right now, the 'action' and 'method' are set to the `<form>` tag.
That's normal because in traditional HTML, only forms and links can send HTTP requests.

HTMX upgrades and completes HTML as a hypertext. With HTMX, 

1. _Any_ HTML element to make an HTTP request.
2. _All_ events to trigger HTTP requests, not just clicks and submits.
3. _All_ HTTP request methods are available in HTML.
4. You are free to replace arbitrary elements in the HTML (you don't have to replace the whole screen).

It's a huge upgrade, but doesn't come at the cost of complexity and fragility inherent in other Javascript frameworks like React.
It also allows us to build our sites in our choice of web framework backends (like Django or Ruby on Rails).
We aren't forced to code our front and back ends in Javascript.

I've said enough, grug brother. Let's get coding.

## Add and modify templates
For this tutorial, we are going to use the template organization and usage recommended by Adam Chainz
in his [example project](https://github.com/adamchainz/django-htmx/tree/main/example) for Django HTMX.


### Add `contact_form_partial.html`
```html
<!-- contact_form_partial.html -->
<div id="contact-form">
    {% block contact_form %}{% endblock %}
</div>
```

### Add `contact_form.html`

```html
<!-- contact_form.html -->
<!-- base_template will be defined as contact_form_partial.html in our view. -->
{% extends base_template %}

<!-- This block is defined in base_template. -->
{% block contact_form %}
<!-- No method or action attributes. -->
    <form>
        {{ form.as_div }}
        <button hx-post="confirm/"
                hx-target="#contact-form"
                hx-swap="outerHTML"
                type="submit">
            Confirm
        </button>
    </form>
{% endblock %}
```

### Modify `contact_page.html`
```html
% extends 'base.html' %}

{% block content %}
    <!-- We moved the form to 'contact_form.html', so include it here. -->
    {% include 'contact_form.html' %}
{% endblock %}
```

### Modify `confirmation_page.html`
```html
{% extends base_template %}

<!-- contact_form, not content -->
{% block contact_form %}
    <form>
        {% for field in form %}
            <div>
<!-- Important! -->
<!--  -->
            {{ field.as_hidden }}
            {{ field.label }}:
            {{ field.value }}
            </div>
        {% endfor %}
        <button hx-post="send/"
                hx-target="#contact-form"
                hx-swap="outerHTML"
                type="submit">
            Send
        </button>
    </form>
{% endblock %}
```

### Modify `success_page.html`
```html
{% extends base_template %}

{% block contact_form %}
    <h1>Complete</h1>
{% endblock %}
```

Here are long last is our HTMX. Let's zoom in.

```html
<form>
    {{ form.as_div }}
    <button hx-post="confirm/"
            hx-target="#contact-form"
            hx-swap="outerHTML"
            type="submit">
        Confirm
    </button>
</form>
```

Like I wrote above, HTMX lets us send HTTP requests, like POST, using _any_ element,
not just forms. In this case, we could put the HTMX attributes in the `<form>` tag
and the results would stay the same.

`hx-post="confirm/"` is like a combination of `method="post"` and `action="confirm/"`.
The response to the request will replace the `hx-target` using the swap method in
`hx-swap`.

## Modify views

```python
from django.shortcuts import render, redirect
from .forms import ContactForm
from django.views.generic import FormView, TemplateView

class ContactPageView(FormView):
    template_name = 'contact_page.html'
    # contact_page.html {% includes %} 'contact_form.html'
    # contact_form.html extends base_template.
    base_template = 'contact_form_partial.html'
    # We add base_template to the context so that we can reference it in the template.
    extra_context = {'base_template': base_template}
    form_class = ContactForm
    success_url = '/confirm/'


class ConfirmationView(FormView):
    template_name = 'confirmation_page.html'
    base_template = 'contact_form_partial.html'
    extra_context = {'base_template': base_template}
    form_class = ContactForm
    submit = False
    success_url = '/success/'

    # We need to override the post method of FormView to see the confirmation 'page'.
    def post(self, request, *args, **kwargs):
        # See urls.py
        if self.submit is True:
            return self.validate_form()
        return render(self.request, self.template_name, self.get_context_data())
    
    # Create a ContactForm instance with POST request data and validate it.
    def validate_form(self):
        form_class = self.get_form_class()
        form = self.get_form(form_class)
        if form.is_valid():
            return self.form_valid(form)
    
    def form_valid(self, form):
        form.send()
        return redirect(self.success_url)


class SuccessView(TemplateView):
    template_name = 'success_page.html'
    base_template = 'contact_form_partial.html'
    extra_context = {'base_template': base_template}
```

See comments for details. We override the `post` method in `ConfirmationView` to first
show the confirmation template, then actually submit and send the email when the 
user clicks the submit button on this view.

## Modify `urls.py`

```python
urlpatterns = [
    path('', views.ContactPageView.as_view(), name='contact_page'),
    # Change this line
    path('confirm/', views.ConfirmationView.as_view()),
    # Add this line
    path('send/', views.ConfirmationView.as_view(submit=True)),
    path('success/', views.SuccessView.as_view())
]
```

